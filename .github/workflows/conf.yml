name: CI

on:
  push:
    branches: [ final ]

jobs:
  build:
    runs-on: self-hosted
    env:
      PASSWORD: ${{ secrets.CI_REGISTRY_PASSWORD }}
    steps:
    - name: Login to Docker Hub
      run: echo $PASSWORD | docker login -u "tvoilex" --password-stdin docker.io
    - name: Docker Image build
      run: cd /home/nodejs/server/node-js && sudo docker-compose build
    - name: test
      run:  echo ${{ github.sha }}
    - name: Docker Tag
      run: sudo docker tag node-js_nodejs_app:latest docker.io/tvoilex/nodejs:${{ github.sha }}
    - name: Push to Docker Hub
      run: sudo docker push docker.io/tvoilex/nodejs:${{ github.sha }}
  deploy:
    runs-on: self-hosted
    needs: build
    steps:
    - name: Docker Pull
      run: sudo docker pull docker.io/tvoilex/nodejs:${{ github.sha }}
    - name: Docker build 
      run: cd /home/nodejs/server/node-js && sudo docker-compose build --pull && sudo docker-compose down && sudo docker-compose up -d

